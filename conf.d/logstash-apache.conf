input {
  beats {
    port => 5400
  }
}

filter {
  if [type] == "apache" {
    grok {
      match => { "message" => [
        "%{COMBINEDAPACHELOG}",
        "%{COMMONAPACHELOG}"
      ]}
      overwrite => ["message"]
    }
    
    # Конвертируем некоторые поля в нужные типы
    mutate {
      convert => [
        ["response", "integer"],
        ["bytes", "integer"],
        ["responsetime", "float"]
      ]
      # Удаляем ненужные кавычки из referrer
      gsub => [
        "referrer", "\"", ""
      ]
      add_tag => ["apache"]
    }
    
    # Парсим дату из timestamp
    date {
      match => [ "timestamp", "dd/MMM/YYYY:HH:mm:ss Z" ]
      remove_field => [ "timestamp" ]
    }
    
    # Парсим user-agent
    useragent {
      source => "agent"
      target => "useragent"
    }
    
    # Добавляем теги для ошибок
    if [response] >= 400 {
      mutate {
        add_tag => ["apache_error"]
      }
    }
    
    # Добавляем теги для запросов с определенными HTTP-методами
    if [verb] in ["POST", "PUT", "DELETE"] {
      mutate {
        add_tag => ["apache_write"]
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://localhost:9200"]
    index => "weblogs-%{+YYYY.MM.dd}"
    document_type => "apache_logs"
  }
  stdout { codec => rubydebug }
}
